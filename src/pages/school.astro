---
import Layout from '../layouts/Layout.astro';
import { GraduationCap, BookOpen, PenTool, Wrench, Globe, Dice6 } from 'lucide-astro';

// Mappa icone disponibili
const iconMap = { GraduationCap, BookOpen, PenTool, Wrench, Globe, Dice6 };

// Importa i file dalla cartella /schools
interface School {
    frontmatter: {
        title: string;
        field?: string;
        institute?: string;
        location?: string;
        date?: string;
        dateFrom?: string;
        dateTo?: string | null;
        icon?: string;
        description?: string | string[];
    };
}

const normalizeDate = (d: string) => {
    if (!d) return new Date(0);

    if (/^\d{6}xx$/.test(d)) {
        // 200708xx → agosto 2007
        const year = d.slice(0, 4);
        const month = d.slice(4, 6);
        return new Date(`${year}-${month}-01`);
    }

    if (/^\d{4}xxxx$/.test(d)) {
        // 2007xxxx → gennaio 2007
        const year = d.slice(0, 4);
        return new Date(`${year}-01-01`);
    }

    if (/^\d{8}$/.test(d)) {
        // 20250101 → 1 gennaio 2025
        const year = d.slice(0, 4);
        const month = d.slice(4, 6);
        const day = d.slice(6, 8);
        return new Date(`${year}-${month}-${day}`);
    }

    const parsed = new Date(d);
    return isNaN(parsed.getTime()) ? new Date(0) : parsed;
};

// const schools = (await Astro.glob<School>('../pages/schools/*.astro')).sort(
//     (a, b) => normalizeDate(b.frontmatter.dateFrom).getTime() - normalizeDate(a.frontmatter.dateFrom).getTime()
// );
const schools = (await Astro.glob<School>('../pages/schools/*.astro')).sort((a, b) => {
    const dateA = normalizeDate(a.frontmatter.date || a.frontmatter.dateFrom);
    const dateB = normalizeDate(b.frontmatter.date || b.frontmatter.dateFrom);
    return dateB.getTime() - dateA.getTime(); // dal più recente al più vecchio
});

const formatDate = (input: string | number): string => {
    if (!input) return '';
    const d = String(input);

    // Identifica tipo di formato e normalizza
    let year = 0,
        month = 0,
        day = 1;

    if (/^\d{4}xxxx$/.test(d)) {
        // 2007xxxx → solo anno
        return d.slice(0, 4);
    } else if (/^\d{6}xx$/.test(d)) {
        // 200708xx → mese/anno
        [year, month] = [d.slice(0, 4), d.slice(4, 6)].map(Number);
    } else if (/^\d{8}$/.test(d)) {
        // 20250101 → giorno/mese/anno
        [year, month, day] = [d.slice(0, 4), d.slice(4, 6), d.slice(6, 8)].map(Number);
    } else if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
        // 2020-01-01
        [year, month, day] = d.split('-').map(Number);
    } else if (/^\d{4}-\d{2}$/.test(d)) {
        // 2007-08
        [year, month] = d.split('-').map(Number);
    } else {
        const parsed = new Date(d);
        if (isNaN(parsed.getTime())) return '';
        year = parsed.getFullYear();
        month = parsed.getMonth() + 1;
        day = parsed.getDate();
    }

    const date = new Date(year, month - 1, day);
    const opts: Intl.DateTimeFormatOptions = {
        year: 'numeric',
        month: 'long',
        ...(day !== 1 || /\d{8}|\d{4}-\d{2}-\d{2}/.test(d) ? { day: '2-digit' } : {})
    };

    return date.toLocaleDateString('it-IT', opts);
};
---

<Layout title="Percorso formativo — Daniele Odorico">
    <section class="timeline max-w-7xl mx-auto my-20 relative">
        <h1 class="text-4xl sm:text-5xl font-bold leading-tight mb-20 text-[#f2f2f2] text-center">Percorso formativo e competenze</h1>

        <!-- Linea centrale dietro le card -->
        <div class="timeline-line"></div>

        <!-- CARD DI SINTESI (in cima) -->
        <!-- CARD DI SINTESI (in cima) -->
        <div class="timeline-item center">
            <article class="card summary-card visible">
                <div class="card-header center">
                    <GraduationCap class="icon-symbol" />
                    <h3 class="card-title">Competenze e Formazione</h3>
                </div>

                <p class="text-[#bfbfbf] text-sm leading-relaxed text-justify">
                    In questa sezione ripercorro il mio percorso di studi, corsi professionali e certificazioni che hanno contribuito alla mia crescita come
                    analista e programmatore full-stack.
                    <br /><br />
                    Le competenze tecniche descritte di seguito sono state acquisite e consolidate nelle diverse esperienze professionali. I dettagli completi dei
                    progetti e dei ruoli ricoperti sono disponibili nella sezione
                    <a href="/job" class="text-[#00bcd4] underline decoration-dotted hover:text-[#00eaff]">Esperienze Professionali</a>.
                </p>

                <div class="skills-summary mt-8 space-y-6 text-sm text-[#bfbfbf]">
                    <!-- ENCO / STORE-PA -->
                    <div class="skill-block">
                        <p class="text-[#00bcd4] font-semibold mb-2">2000/2013 : EncoPro S.r.l. — Store-PA S.r.l.</p>
                        <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                            <span class="gray-tag">COBOL</span>
                            <span class="gray-tag">Visual Basic</span>
                            <span class="gray-tag">Oracle</span>
                            <span class="gray-tag">.NET</span>
                            <span class="gray-tag">C#</span>
                            <span class="gray-tag">PHP</span>
                            <span class="gray-tag">HTML</span>
                            <span class="gray-tag">Photoshop</span>
                        </div>
                    </div>

                    <!-- GPI (prima fase) -->
                    <div class="skill-block">
                        <p class="text-[#00bcd4] font-semibold mb-2">2014/2018 : GPI S.p.A. — Prima fase</p>
                        <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                            <span class="gray-tag">4js</span>
                            <span class="gray-tag">Oracle</span>
                            <span class="gray-tag">PL/SQL</span>
                            <span class="gray-tag">Java</span>
                        </div>
                    </div>

                    <!-- GPI (seconda fase) -->
                    <div class="skill-block">
                        <p class="text-[#00bcd4] font-semibold mb-2">2018/oggi : GPI S.p.A. — Seconda fase</p>
                        <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                            <span class="gray-tag">Java</span>
                            <span class="gray-tag">Angular</span>
                            <span class="gray-tag">TypeScript</span>
                            <span class="gray-tag">HTML</span>
                            <span class="gray-tag">JavaScript</span>
                            <span class="gray-tag">Oracle</span>
                        </div>
                    </div>
                </div>
            </article>
        </div>

        {
            schools.map((school, index) => {
                const { title, institute, field, location, date, dateFrom, dateTo, description, icon } = school.frontmatter;
                const alignRight = index % 2 === 0;
                const IconComponent = iconMap[icon] || GraduationCap;

                return (
                    <div class={`timeline-item ${alignRight ? 'right' : 'left'}`}>
                        <article class="card fade-in">
                            {/* Icona e Titolo */}
                            <div class={`card-header ${alignRight ? 'right' : 'left'}`}>
                                <IconComponent class="icon-symbol" />
                                <h3 class="card-title">{title}</h3>
                            </div>

                            {/* Date */}
                            {date && <p class="text-[#999] text-sm mb-4">{formatDate(date)}</p>}
                            {dateFrom && (
                                <p class="text-[#999] text-sm mb-4">
                                    {formatDate(dateFrom)} — {dateTo ? formatDate(dateTo) : 'oggi'}
                                </p>
                            )}

                            {/* Scuola */}
                            {institute && <p class="text-[#00bcd4] font-mono text-sm mb-1">{institute}</p>}
                            {location && <p class="text-[#999] text-xs mb-3">{location}</p>}

                            {field && (
                                <p class="text-[#bfbfbf] text-sm mb-1">
                                    <b>{field}</b>
                                </p>
                            )}

                            {/* Descrizione */}
                            {description && (
                                <div class="text-[#bfbfbf] text-sm leading-relaxed text-justify">
                                    {Array.isArray(description) ? description.map((p) => <p class="mb-1" set:html={p} />) : <p set:html={description} />}
                                </div>
                            )}
                        </article>
                    </div>
                );
            })
        }
    </section>

    <script>
        // Dettagli company
        function toggleDetails(el) {
            const details = el.nextElementSibling;
            const arrow = el.querySelector('.arrow');
            if (!details) return;

            const willOpen = details.classList.contains('collapsed');
            details.classList.toggle('collapsed');

            if (arrow) {
                arrow.textContent = willOpen ? '▲' : '▼';
            }
        }

        document.querySelectorAll('[data-toggle]').forEach((el) => {
            el.addEventListener('click', () => toggleDetails(el));
        });

        // Linea che si illumina progressivamente durante lo scroll
        window.addEventListener('scroll', () => {
            const line = document.querySelector('.timeline-line');
            if (line instanceof HTMLElement) {
                const scrollTop = window.scrollY;
                const docHeight = document.body.scrollHeight - window.innerHeight;
                const scrollPercent = scrollTop / docHeight;
                line.style.setProperty('--scroll', `${Math.min(scrollPercent * 100, 100)}%`);
            }
        });

        // Fade-in per le card
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) entry.target.classList.add('visible');
                });
            },
            { threshold: 0.2 }
        );
        document.querySelectorAll('.fade-in').forEach((el) => observer.observe(el));
    </script>

    <style>
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Linea centrale, dietro le card */
        .timeline-line {
            position: absolute;
            left: 50%;
            top: 5rem;
            bottom: 0;
            width: 3px;
            background: linear-gradient(
                to bottom,
                rgba(255, 79, 174, 0.6) 0%,
                /* rosa più intenso in alto */ rgba(255, 79, 174, 0.45) 25%,
                rgba(0, 188, 212, 0.55) 75%,
                /* azzurro più brillante in basso */ rgba(0, 188, 212, 0.4) 100%
            );
            transform: translateX(-50%);
            border-radius: 2px;
            z-index: 0;
            pointer-events: none;
        }

        /* Elementi timeline */
        .timeline-item {
            width: 80%;
            position: relative;
            margin-bottom: 4rem;
            z-index: 1;
        }
        .timeline-item.left {
            margin-left: 0;
            text-align: left;
        }
        .timeline-item.right {
            margin-left: auto;
            text-align: right;
        }
        .timeline-item.left .icon-node {
            right: -58px;
        }
        .timeline-item.right .icon-node {
            left: -58px;
        }

        /* Nodo con icona */
        .icon-node {
            display: none;
        }

        /* Icona */
        .icon-symbol {
            width: 48px;
            height: 48px;
            color: #ff4fae;
            background: rgba(255, 79, 174, 0.12);
            border-radius: 50%;
            padding: 8px;
            transition:
                transform 0.25s ease,
                background-color 0.25s ease;
        }
        .icon-symbol:hover {
            transform: scale(1.1);
            background: rgba(255, 79, 174, 0.25);
        }

        /* Card */
        .card {
            position: relative;
            background: #0b0e14;
            border: 1px solid rgba(0, 188, 212, 0.25); /* bordo azzurro più netto */
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: 0 0 12px rgba(0, 188, 212, 0.08); /* leggero effetto soft */
            transition:
                border-color 0.25s ease,
                transform 0.25s ease,
                opacity 0.6s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        .card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .card:hover {
            border-color: rgba(0, 188, 212, 0.5);
            transform: translateY(-2px);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .card-header.left {
            justify-content: flex-start;
        }
        .card-header.right {
            flex-direction: row-reverse;
            text-align: right;
        }
        .card-title {
            color: #f2f2f2;
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0;
        }
        .card-body {
            color: #bfbfbf;
            line-height: 1.6;
        }

        /* Icona interna */
        .icon-symbol {
            width: 36px;
            height: 36px;
            color: #ff4fae;
            background: rgba(255, 79, 174, 0.1);
            border-radius: 50%;
            padding: 6px;
            flex-shrink: 0;
            transition:
                transform 0.25s ease,
                background-color 0.25s ease;
        }
        .icon-symbol:hover {
            transform: scale(1.1);
            background: rgba(255, 79, 174, 0.25);
        }

        @media (max-width: 768px) {
            .timeline-item {
                width: 100%;
                text-align: left !important;
            }
            .icon-node {
                left: -30px !important;
                right: auto !important;
            }
            .timeline-line {
                left: 8px;
                transform: none;
            }
        }

        /* Nasconde l’icona su smartphone */
        @media (max-width: 768px) {
            .icon-symbol {
                display: none;
            }
            .card-header {
                justify-content: flex-start !important;
                text-align: left !important;
            }
        }

        /* Card di dettaglio Azienda e Mansioni */
        .company-details,
        .duty-details {
            transition: all 0.35s ease;
            overflow: hidden;
            opacity: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 188, 212, 0.15);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 0.6rem;
            display: inline-block;
            width: 100%;
            box-shadow: inset 0 0 8px rgba(0, 188, 212, 0.05);
            max-height: 500px;
        }
        .company-details.collapsed,
        .duty-details.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .arrow {
            display: inline-block;
        }

        /* Parole speciali dentro le description delle mansioni */
        :global(.blue-tag) {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 0.8rem;
            color: #00bcd4;
            background: rgba(255, 255, 255, 0.04);
            padding: 0.15rem 0.35rem;
            border-radius: 0.35rem;
        }
        :global(.pink-tag) {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 0.8rem;
            color: #ff4fae;
            background: rgba(255, 255, 255, 0.04);
            padding: 0.15rem 0.35rem;
            border-radius: 0.35rem;
        }
        :global(.gray-tag) {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 0.8rem;
            color: #cccccc;
            background: rgba(255, 255, 255, 0.04);
            padding: 0.15rem 0.35rem;
            border-radius: 0.35rem;
        }
    </style>
</Layout>
